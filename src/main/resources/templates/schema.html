<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${owner}">Esquema:</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .badge-table {
            background-color: #6c757d;
        }

        .badge-column {
            background-color: #17a2b8;
        }

        .badge-view {
            background-color: #28a745;
        }

        .type-oracle {
            color: #c7254e;
            background-color: #f9f2f4;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .type-postgres {
            color: #31708f;
            background-color: #d9edf7;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">DB Inspector</a>
        <span class="navbar-text text-light">Esquema: <strong th:text="${owner}"></strong></span>
    </div>
</nav>

<div class="container-fluid mt-4">
    <!-- Mensaje de debug -->
    <div class="alert alert-info" th:if="${debug}">
        <strong>Debug Info:</strong><br>
        Total Tables: <span th:text="${schema.totalTables}"></span><br>
        Total Views: <span th:text="${schema.totalViews}"></span><br>
        Table Details Size: <span th:text="${schema.tableDetails.size()}"></span>
    </div>

    <div class="row">
        <!-- Sidebar con estadísticas -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-bar-chart"></i> Estadísticas
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tablas:</span>
                        <span class="badge bg-secondary" th:text="${schema.totalTables}"></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Vistas:</span>
                        <span class="badge bg-success" th:text="${schema.totalViews}"></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Columnas:</span>
                        <span class="badge bg-info" th:text="${#aggregates.sum(schema.tables.![rowCount])}"></span>
                    </div>
                    <hr>
                    <div class="d-grid gap-2">
                        <a th:href="@{/migration(owner=${owner})}" class="btn btn-warning btn-sm">
                            <i class="bi bi-arrow-right-circle"></i> Analizar Migración
                        </a>
                        <a href="/compare" class="btn btn-info btn-sm">
                            <i class="bi bi-compass"></i> Comparar con otro
                        </a>
                        <a href="/" class="btn btn-secondary btn-sm">
                            <i class="bi bi-house"></i> Inicio
                        </a>
                        <a th:href="@{/file-analysis(owner=${owner})}" class="btn btn-danger btn-sm">
                            <i class="bi bi-file-earmark-binary"></i> Analizar Archivos
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="col-md-9">
            <!-- Tablas -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-table"></i> Tablas (<span th:text="${schema.totalTables}"></span>)
                        </span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                            <tr>
                                <th>Nombre</th>
                                <th>Columnas</th>
                                <th>Índices</th>
                                <th>Filas (aprox)</th>
                                <th>Acciones</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="table : ${schema.tables}">
                                <td>
                                    <strong th:text="${table.name}"></strong>
                                </td>
                                <td>
                                            <span th:if="${schema.tableDetails.containsKey(table.name)}"
                                                  class="badge bg-info"
                                                  th:text="${schema.tableDetails[table.name].columns.size()}">
                                            </span>
                                    <span th:unless="${schema.tableDetails.containsKey(table.name)}"
                                          class="badge bg-secondary">?</span>
                                </td>
                                <td>
                                            <span th:if="${schema.tableDetails.containsKey(table.name)}"
                                                  class="badge bg-warning text-dark"
                                                  th:text="${schema.tableDetails[table.name].indexes.size()}">
                                            </span>
                                    <span th:unless="${schema.tableDetails.containsKey(table.name)}"
                                          class="badge bg-secondary">?</span>
                                </td>
                                <td>
                                            <span th:if="${table.rowCount > 0}"
                                                  th:text="${#numbers.formatDecimal(table.rowCount, 0, 'COMMA', 0, 'POINT')}">
                                            </span>
                                    <span th:unless="${table.rowCount > 0}" class="text-muted">-</span>
                                </td>
                                <td>
                                    <a th:href="@{/table-details(owner=${owner}, table=${table.name})}"
                                       class="btn btn-sm btn-outline-primary"
                                       th:if="${schema.tableDetails.containsKey(table.name)}">
                                        <i class="bi bi-eye"></i> Detalles
                                    </a>
                                    <button class="btn btn-sm btn-outline-secondary" disabled
                                            th:unless="${schema.tableDetails.containsKey(table.name)}">
                                        <i class="bi bi-eye-slash"></i> Sin detalles
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Vistas -->
            <div class="card mt-4" th:if="${not schema.views.empty}">
                <div class="card-header">
                    <i class="bi bi-eye"></i> Vistas (<span th:text="${schema.totalViews}"></span>)
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-2" th:each="view : ${schema.views}">
                            <div class="card border-success">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span th:text="${view}"></span>
                                        <span class="badge bg-success">VISTA</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumen de columnas (solo primeras 5 tablas para no sobrecargar) -->
            <div class="card mt-4" th:if="${schema.totalTables > 0}">
                <div class="card-header">
                    <i class="bi bi-columns-gap"></i> Resumen de Columnas (Primeras 5 tablas)
                </div>
                <div class="card-body">
                    <div class="accordion" id="columnsAccordion">
                        <div class="accordion-item" th:each="table, iter : ${schema.tables}" th:if="${iter.index < 5}">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse"
                                        th:data-bs-target="'#collapse' + ${iter.index}">
                                    <span th:text="${table.name}"></span>
                                    <span class="badge bg-secondary ms-2"
                                          th:if="${schema.tableDetails.containsKey(table.name)}"
                                          th:text="${schema.tableDetails[table.name].columns.size()}">
                                        </span>
                                    <span class="badge bg-secondary ms-2"
                                          th:unless="${schema.tableDetails.containsKey(table.name)}">
                                            0
                                        </span>
                                </button>
                            </h2>
                            <div th:id="'collapse' + ${iter.index}"
                                 class="accordion-collapse collapse"
                                 data-bs-parent="#columnsAccordion">
                                <div class="accordion-body" th:if="${schema.tableDetails.containsKey(table.name)}">
                                    <table class="table table-sm">
                                        <thead>
                                        <tr>
                                            <th>Columna</th>
                                            <th>Tipo</th>
                                            <th>Longitud</th>
                                            <th>Null</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="col : ${schema.tableDetails[table.name].columns}">
                                            <td th:text="${col.name}"></td>
                                            <td>
                                                <span class="type-oracle" th:text="${col.type}"></span>
                                            </td>
                                            <td>
                                                        <span th:if="${col.length != null}"
                                                              th:text="${col.length}"></span>
                                                <span th:if="${col.precision != null and col.scale != null}"
                                                      th:text="'(' + ${col.precision} + ',' + ${col.scale} + ')'">
                                                        </span>
                                                <span th:if="${col.length == null and col.precision == null}"
                                                      class="text-muted">-</span>
                                            </td>
                                            <td>
                                                <span th:if="${col.nullable}"
                                                      class="badge bg-warning text-dark">SÍ</span>
                                                <span th:unless="${col.nullable}" class="badge bg-dark">NO</span>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="accordion-body" th:unless="${schema.tableDetails.containsKey(table.name)}">
                                    <div class="alert alert-warning">
                                        No se pudieron obtener los detalles de las columnas para esta tabla.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:if="${schema.totalTables > 5}" class="text-center mt-3">
                        <small class="text-muted">
                            Mostrando 5 de <span th:text="${schema.totalTables}"></span> tablas.
                            Usa el enlace de detalles para ver tablas específicas.
                        </small>
                    </div>
                </div>
            </div>

            <!-- Mensaje si no hay tablas -->
            <div th:if="${schema.totalTables == 0}" class="alert alert-warning mt-4">
                <i class="bi bi-exclamation-triangle"></i> No se encontraron tablas en el esquema <strong
                    th:text="${owner}"></strong>.
                Verifica que el nombre del esquema sea correcto y que tengas permisos de lectura.
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>